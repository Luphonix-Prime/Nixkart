{% extends 'base.html' %}

{% block title %}Edit Profile - ShopSmart{% endblock %}

{% block extra_css %}
<style>
    .edit-profile-container {
        padding: var(--spacing-lg) 0;
    }
    
    .edit-profile-header {
        margin-bottom: var(--spacing-xl);
        text-align: center;
    }
    
    .edit-profile-title {
        margin-bottom: var(--spacing-md);
    }
    
    .edit-profile-subtitle {
        color: var(--text-light);
        max-width: 700px;
        margin: 0 auto;
    }
    
    .edit-profile-content {
        display: grid;
        grid-template-columns: 1fr 3fr;
        gap: var(--spacing-xl);
    }
    
    .edit-profile-sidebar {
        background-color: var(--white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--card-shadow);
        padding: var(--spacing-lg);
    }
    
    .edit-profile-photo {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-lg);
        border-bottom: 1px solid #eee;
    }
    
    .edit-profile-image {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: #f5f5f5;
        margin-bottom: var(--spacing-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--primary-color);
        position: relative;
        overflow: hidden;
    }
    
    .edit-profile-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .edit-profile-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .edit-profile-image-edit {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        font-size: 0.9rem;
        padding: var(--spacing-xs);
        text-align: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .edit-profile-image:hover .edit-profile-image-edit {
        opacity: 1;
    }
    
    .edit-profile-name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }
    
    .edit-profile-member-since {
        color: var(--text-light);
        font-size: 0.9rem;
    }
    
    .edit-profile-nav {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .edit-profile-nav-item {
        margin-bottom: var(--spacing-sm);
    }
    
    .edit-profile-nav-link {
        display: flex;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius-sm);
        color: var(--text-color);
        transition: all 0.3s ease;
    }
    
    .edit-profile-nav-link:hover {
        background-color: #f5f5f5;
        color: var(--primary-color);
    }
    
    .edit-profile-nav-link.active {
        background-color: var(--primary-color);
        color: var(--white);
    }
    
    .edit-profile-nav-icon {
        margin-right: var(--spacing-md);
        width: 20px;
        text-align: center;
    }
    
    .edit-profile-main {
        background-color: var(--white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--card-shadow);
        padding: var(--spacing-lg);
    }
    
    .edit-profile-tabs {
        margin-bottom: var(--spacing-lg);
    }
    
    .edit-profile-tabs-nav {
        display: flex;
        border-bottom: 1px solid #eee;
    }
    
    .edit-profile-tab-btn {
        padding: var(--spacing-md) var(--spacing-lg);
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        position: relative;
        background: none;
        border: none;
        transition: color 0.3s ease;
    }
    
    .edit-profile-tab-btn::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 0;
        height: 3px;
        background-color: var(--primary-color);
        transition: width 0.3s ease;
    }
    
    .edit-profile-tab-btn:hover {
        color: var(--primary-color);
    }
    
    .edit-profile-tab-btn.active {
        color: var(--primary-color);
    }
    
    .edit-profile-tab-btn.active::after {
        width: 100%;
    }
    
    .edit-profile-tab-content {
        display: none;
        padding: var(--spacing-lg) 0;
    }
    
    .edit-profile-tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }
    
    .form-section {
        margin-bottom: var(--spacing-lg);
    }
    
    .form-section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-sm);
        border-bottom: 1px solid #eee;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
    }
    
    .form-group {
        margin-bottom: var(--spacing-md);
    }
    
    .form-label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
    }
    
    .form-text {
        margin-top: var(--spacing-xs);
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }
    
    .btn-cancel {
        padding: var(--spacing-sm) var(--spacing-lg);
        background-color: var(--white);
        color: var(--text-color);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    
    .btn-cancel:hover {
        background-color: #f5f5f5;
        border-color: #ccc;
    }
    
    .btn-save {
        padding: var(--spacing-sm) var(--spacing-lg);
        background-color: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s ease, transform 0.3s ease;
    }
    
    .btn-save:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
    }
    
    .address-list {
        margin-top: var(--spacing-lg);
    }
    
    .address-item {
        position: relative;
        border: 1px solid #ddd;
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        transition: border-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .address-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .address-item-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .address-badge {
        background-color: #e6f7ed;
        color: var(--success-color);
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
    }
    
    .address-content {
        margin-bottom: var(--spacing-md);
    }
    
    .address-actions {
        display: flex;
        gap: var(--spacing-sm);
    }
    
    .btn-add-address {
        display: inline-block;
        margin-top: var(--spacing-md);
        padding: var(--spacing-sm) var(--spacing-lg);
        background-color: var(--white);
        color: var(--primary-color);
        border: 1px dashed var(--primary-color);
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s ease, transform 0.3s ease;
        text-align: center;
    }
    
    .btn-add-address:hover {
        background-color: rgba(67, 97, 238, 0.05);
        transform: translateY(-2px);
    }
    
    .address-form {
        display: none;
        margin-top: var(--spacing-lg);
        padding: var(--spacing-lg);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-md);
        background-color: #f9f9f9;
    }
    
    .address-form.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }
    
    .upload-progress {
        display: none;
        margin-top: var(--spacing-md);
        height: 4px;
        background-color: #f0f0f0;
        border-radius: 2px;
        overflow: hidden;
    }
    
    .upload-progress-bar {
        height: 100%;
        background-color: var(--primary-color);
        width: 0;
        transition: width 0.3s ease;
    }
    
    @media (max-width: 992px) {
        .edit-profile-content {
            grid-template-columns: 1fr;
        }
        
        .edit-profile-sidebar {
            margin-bottom: var(--spacing-lg);
        }
        
        .edit-profile-photo {
            flex-direction: row;
            align-items: center;
            gap: var(--spacing-lg);
        }
        
        .edit-profile-name, .edit-profile-member-since {
            text-align: left;
        }
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .edit-profile-tabs-nav {
            flex-wrap: wrap;
        }
        
        .edit-profile-tab-btn {
            flex: 1;
            text-align: center;
            padding: var(--spacing-sm) var(--spacing-md);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <div class="edit-profile-header slide-up">
        <h1 class="edit-profile-title page-title">Edit Profile</h1>
        <p class="edit-profile-subtitle">Update your personal information, addresses, and preferences.</p>
    </div>
    
    <div class="edit-profile-content">
        <div class="edit-profile-sidebar slide-in-left">
            <div class="edit-profile-photo">
                <div class="edit-profile-image">
                    {% if user.profile.image %}
                        <img src="{{ user.profile.image.url }}" alt="{{ user.get_full_name }}" id="profile-image-preview">
                    {% else %}
                        <div class="edit-profile-image-placeholder" id="profile-image-preview-placeholder">
                            {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                        </div>
                    {% endif %}
                    
                    <label for="profile-image-upload" class="edit-profile-image-edit">
                        <i class="fas fa-camera"></i> Change
                    </label>
                    <input type="file" id="profile-image-upload" accept="image/*" style="display: none">
                </div>
                <div>
                    <h3 class="edit-profile-name">{{ user.get_full_name|default:user.username }}</h3>
                    <p class="edit-profile-member-since">Member since {{ user.date_joined|date:"F Y" }}</p>
                </div>
            </div>
            
            <ul class="edit-profile-nav">
                <li class="edit-profile-nav-item">
                    <a href="{% url 'profile' %}" class="edit-profile-nav-link">
                        <span class="edit-profile-nav-icon"><i class="fas fa-user"></i></span>
                        My Profile
                    </a>
                </li>
                <li class="edit-profile-nav-item">
                    <a href="{% url 'user_orders' %}" class="edit-profile-nav-link">
                        <span class="edit-profile-nav-icon"><i class="fas fa-shopping-bag"></i></span>
                        My Orders
                    </a>
                </li>
                <li class="edit-profile-nav-item">
                    <a href="{% url 'wishlist' %}" class="edit-profile-nav-link">
                        <span class="edit-profile-nav-icon"><i class="fas fa-heart"></i></span>
                        My Wishlist
                    </a>
                </li>
                <li class="edit-profile-nav-item">
                    <a href="{% url 'password_change' %}" class="edit-profile-nav-link">
                        <span class="edit-profile-nav-icon"><i class="fas fa-lock"></i></span>
                        Change Password
                    </a>
                </li>
                <li class="edit-profile-nav-item">
                    <a href="{% url 'logout' %}" class="edit-profile-nav-link">
                        <span class="edit-profile-nav-icon"><i class="fas fa-sign-out-alt"></i></span>
                        Logout
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="edit-profile-main slide-in-right">
            <div class="edit-profile-tabs">
                <div class="edit-profile-tabs-nav">
                    <button class="edit-profile-tab-btn active" data-tab="personal-info">Personal Information</button>
                    <button class="edit-profile-tab-btn" data-tab="addresses">Addresses</button>
                    <button class="edit-profile-tab-btn" data-tab="preferences">Preferences</button>
                </div>
                
                <!-- Personal Information Tab -->
                <div class="edit-profile-tab-content active" id="personal-info-tab">
                    <form id="personal-info-form" method="POST" action="{% url 'edit_profile' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="personal_info">
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Basic Information</h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="first_name" class="form-label">First Name</label>
                                    <input type="text" id="first_name" name="first_name" class="form-control" value="{{ user.first_name }}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="last_name" class="form-label">Last Name</label>
                                    <input type="text" id="last_name" name="last_name" class="form-control" value="{{ user.last_name }}" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" id="email" name="email" class="form-control" value="{{ user.email }}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" id="phone" name="phone" class="form-control" value="{{ user.profile.phone|default:'' }}">
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Additional Information</h3>
                            
                            <div class="form-group">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>
                                <input type="date" id="date_of_birth" name="date_of_birth" class="form-control" value="{{ user.profile.date_of_birth|date:'Y-m-d'|default:'' }}">
                            </div>
                            
                            <div class="form-group">
                                <label for="bio" class="form-label">Bio</label>
                                <textarea id="bio" name="bio" class="form-control" rows="3">{{ user.profile.bio|default:'' }}</textarea>
                                <small class="form-text">A short description about yourself.</small>
                            </div>
                        </div>
                        
                        <div class="upload-progress" id="profile-image-progress">
                            <div class="upload-progress-bar" id="profile-image-progress-bar"></div>
                        </div>
                        
                        <div class="form-actions">
                            <a href="{% url 'profile' %}" class="btn-cancel">Cancel</a>
                            <button type="submit" class="btn-save">Save Changes</button>
                        </div>
                    </form>
                </div>
                
                <!-- Addresses Tab -->
                <div class="edit-profile-tab-content" id="addresses-tab">
                    <div class="address-list">
                        {% if user.addresses.exists %}
                            {% for address in user.addresses.all %}
                                <div class="address-item" id="address-item-{{ address.id }}">
                                    <div class="address-item-title">
                                        <span>{{ address.title }}</span>
                                        {% if address.is_default %}
                                            <span class="address-badge">Default</span>
                                        {% endif %}
                                    </div>
                                    <div class="address-content">
                                        <p>{{ address.name }}</p>
                                        <p>{{ address.address_line1 }}</p>
                                        {% if address.address_line2 %}
                                            <p>{{ address.address_line2 }}</p>
                                        {% endif %}
                                        <p>{{ address.city }}, {{ address.state }} {{ address.zip_code }}</p>
                                        <p>{{ address.country }}</p>
                                        <p>Phone: {{ address.phone }}</p>
                                    </div>
                                    <div class="address-actions">
                                        <button type="button" class="btn btn-sm btn-secondary edit-address-btn" data-address-id="{{ address.id }}">Edit</button>
                                        <button type="button" class="btn btn-sm btn-danger delete-address-btn" data-address-id="{{ address.id }}">Delete</button>
                                        {% if not address.is_default %}
                                            <button type="button" class="btn btn-sm btn-primary make-default-btn" data-address-id="{{ address.id }}">Make Default</button>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>You haven't added any addresses yet.</p>
                        {% endif %}
                        
                        <button type="button" class="btn-add-address" id="add-address-btn">
                            <i class="fas fa-plus"></i> Add New Address
                        </button>
                    </div>
                    
                    <div class="address-form" id="address-form">
                        <h3 class="form-section-title" id="address-form-title">Add New Address</h3>
                        
                        <form id="address-form-element" method="POST" action="{% url 'edit_profile' %}">
                            {% csrf_token %}
                            <input type="hidden" name="form_type" value="address">
                            <input type="hidden" name="address_id" id="address_id" value="">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address_title" class="form-label">Address Title</label>
                                    <input type="text" id="address_title" name="address_title" class="form-control" placeholder="Home, Work, etc." required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="address_name" class="form-label">Full Name</label>
                                    <input type="text" id="address_name" name="address_name" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="address_line1" class="form-label">Address Line 1</label>
                                <input type="text" id="address_line1" name="address_line1" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="address_line2" class="form-label">Address Line 2 (Optional)</label>
                                <input type="text" id="address_line2" name="address_line2" class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address_city" class="form-label">City</label>
                                    <input type="text" id="address_city" name="address_city" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="address_state" class="form-label">State/Province</label>
                                    <input type="text" id="address_state" name="address_state" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address_zip" class="form-label">Zip/Postal Code</label>
                                    <input type="text" id="address_zip" name="address_zip" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="address_country" class="form-label">Country</label>
                                    <select id="address_country" name="address_country" class="form-control" required>
                                        <option value="">Select a country</option>
                                        <option value="US">United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="AU">Australia</option>
                                        <!-- Add more countries as needed -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="address_phone" class="form-label">Phone Number</label>
                                <input type="tel" id="address_phone" name="address_phone" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="address_is_default" name="address_is_default" class="form-check-input">
                                    <label for="address_is_default" class="form-check-label">Set as default address</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-cancel" id="cancel-address-btn">Cancel</button>
                                <button type="submit" class="btn-save">Save Address</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Preferences Tab -->
                <div class="edit-profile-tab-content" id="preferences-tab">
                    <form id="preferences-form" method="POST" action="{% url 'edit_profile' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="preferences">
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Communication Preferences</h3>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="email_notifications" name="email_notifications" class="form-check-input" {% if user.profile.email_notifications %}checked{% endif %}>
                                    <label for="email_notifications" class="form-check-label">Receive email notifications</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="order_updates" name="order_updates" class="form-check-input" {% if user.profile.order_updates %}checked{% endif %}>
                                    <label for="order_updates" class="form-check-label">Receive order updates</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="promotional_emails" name="promotional_emails" class="form-check-input" {% if user.profile.promotional_emails %}checked{% endif %}>
                                    <label for="promotional_emails" class="form-check-label">Receive promotional emails and offers</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="newsletter" name="newsletter" class="form-check-input" {% if user.profile.newsletter %}checked{% endif %}>
                                    <label for="newsletter" class="form-check-label">Subscribe to newsletter</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">Display Preferences</h3>
                            
                            <div class="form-group">
                                <label for="currency" class="form-label">Currency</label>
                                <select id="currency" name="currency" class="form-control">
                                    <option value="USD" {% if user.profile.currency == 'USD' %}selected{% endif %}>US Dollar ($)</option>
                                    <option value="EUR" {% if user.profile.currency == 'EUR' %}selected{% endif %}>Euro (€)</option>
                                    <option value="GBP" {% if user.profile.currency == 'GBP' %}selected{% endif %}>British Pound (£)</option>
                                    <option value="CAD" {% if user.profile.currency == 'CAD' %}selected{% endif %}>Canadian Dollar (C$)</option>
                                    <option value="AUD" {% if user.profile.currency == 'AUD' %}selected{% endif %}>Australian Dollar (A$)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="language" class="form-label">Language</label>
                                <select id="language" name="language" class="form-control">
                                    <option value="en" {% if user.profile.language == 'en' %}selected{% endif %}>English</option>
                                    <option value="es" {% if user.profile.language == 'es' %}selected{% endif %}>Spanish</option>
                                    <option value="fr" {% if user.profile.language == 'fr' %}selected{% endif %}>French</option>
                                    <option value="de" {% if user.profile.language == 'de' %}selected{% endif %}>German</option>
                                    <option value="it" {% if user.profile.language == 'it' %}selected{% endif %}>Italian</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <a href="{% url 'profile' %}" class="btn-cancel">Cancel</a>
                            <button type="submit" class="btn-save">Save Preferences</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab navigation
        const tabButtons = document.querySelectorAll('.edit-profile-tab-btn');
        const tabContents = document.querySelectorAll('.edit-profile-tab-content');
        
        // Check if we should open a specific tab from URL hash
        const hash = window.location.hash;
        if (hash) {
            const tabId = hash.substring(1); // Remove the # symbol
            openTab(tabId);
        }
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                openTab(tabId);
            });
        });
        
        function openTab(tabId) {
            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to the selected button and content
            const selectedButton = document.querySelector(`.edit-profile-tab-btn[data-tab="${tabId}"]`);
            const selectedContent = document.getElementById(`${tabId}-tab`);
            
            if (selectedButton && selectedContent) {
                selectedButton.classList.add('active');
                selectedContent.classList.add('active');
                
                // Update URL hash
                window.location.hash = tabId;
            }
        }
        
        // Profile image upload
        const profileImageUpload = document.getElementById('profile-image-upload');
        const profileImagePreview = document.getElementById('profile-image-preview');
        const profileImagePlaceholder = document.getElementById('profile-image-preview-placeholder');
        const progressBar = document.getElementById('profile-image-progress-bar');
        const progressContainer = document.getElementById('profile-image-progress');
        
        if (profileImageUpload) {
            profileImageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // If there's an image preview element
                        if (profileImagePreview && profileImagePreview.tagName === 'IMG') {
                            profileImagePreview.src = e.target.result;
                        } 
                        // If there's a placeholder, replace it with an image
                        else if (profileImagePlaceholder) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.id = 'profile-image-preview';
                            img.alt = 'Profile Preview';
                            
                            const parent = profileImagePlaceholder.parentNode;
                            parent.replaceChild(img, profileImagePlaceholder);
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // Upload the image
                    uploadProfileImage(file);
                }
            });
        }
        
        function uploadProfileImage(file) {
            const formData = new FormData();
            formData.append('profile_image', file);
            formData.append('csrfmiddlewaretoken', getCsrfToken());
            
            // Show progress bar
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                }
            });
            
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    
                    if (response.success) {
                        // Show success message
                        showToast('Profile image updated successfully.', 'success');
                    } else {
                        showToast(response.message || 'Failed to update profile image.', 'error');
                    }
                } else {
                    showToast('An error occurred while uploading the image.', 'error');
                }
                
                // Hide progress bar after a delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            });
            
            xhr.addEventListener('error', function() {
                showToast('An error occurred while uploading the image.', 'error');
                progressContainer.style.display = 'none';
            });
            
            xhr.open('POST', '/update-profile-image/', true);
            xhr.send(formData);
        }
        
        // Address form functionality
        const addAddressBtn = document.getElementById('add-address-btn');
        const addressForm = document.getElementById('address-form');
        const cancelAddressBtn = document.getElementById('cancel-address-btn');
        const addressFormElement = document.getElementById('address-form-element');
        const addressFormTitle = document.getElementById('address-form-title');
        const addressIdInput = document.getElementById('address_id');
        
        if (addAddressBtn && addressForm) {
            addAddressBtn.addEventListener('click', function() {
                // Reset form
                addressFormElement.reset();
                addressIdInput.value = '';
                addressFormTitle.textContent = 'Add New Address';
                
                // Show form
                addressForm.classList.add('active');
                
                // Scroll to form
                addressForm.scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        if (cancelAddressBtn) {
            cancelAddressBtn.addEventListener('click', function() {
                addressForm.classList.remove('active');
            });
        }
        
        // Edit address buttons
        const editAddressBtns = document.querySelectorAll('.edit-address-btn');
        
        editAddressBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const addressId = this.dataset.addressId;
                
                // Fetch address data
                fetch(`/get-address/${addressId}/`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const address = data.address;
                        
                        // Fill the form
                        addressIdInput.value = address.id;
                        document.getElementById('address_title').value = address.title;
                        document.getElementById('address_name').value = address.name;
                        document.getElementById('address_line1').value = address.address_line1;
                        document.getElementById('address_line2').value = address.address_line2 || '';
                        document.getElementById('address_city').value = address.city;
                        document.getElementById('address_state').value = address.state;
                        document.getElementById('address_zip').value = address.zip_code;
                        document.getElementById('address_country').value = address.country;
                        document.getElementById('address_phone').value = address.phone;
                        document.getElementById('address_is_default').checked = address.is_default;
                        
                        // Update form title
                        addressFormTitle.textContent = 'Edit Address';
                        
                        // Show form
                        addressForm.classList.add('active');
                        
                        // Scroll to form
                        addressForm.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showToast(data.message || 'Failed to load address.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading address:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
            });
        });
        
        // Delete address buttons
        const deleteAddressBtns = document.querySelectorAll('.delete-address-btn');
        
        deleteAddressBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const addressId = this.dataset.addressId;
                
                if (confirm('Are you sure you want to delete this address?')) {
                    // Send delete request
                    fetch(`/delete-address/${addressId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCsrfToken(),
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove address from DOM
                            const addressItem = document.getElementById(`address-item-${addressId}`);
                            if (addressItem) {
                                addressItem.remove();
                                
                                // Show success message
                                showToast('Address deleted successfully.', 'success');
                                
                                // If no addresses left, show message
                                const addressItems = document.querySelectorAll('.address-item');
                                if (addressItems.length === 0) {
                                    const addressList = document.querySelector('.address-list');
                                    const noAddressMsg = document.createElement('p');
                                    noAddressMsg.textContent = 'You haven\'t added any addresses yet.';
                                    
                                    // Insert before the add button
                                    addressList.insertBefore(noAddressMsg, addAddressBtn);
                                }
                            }
                        } else {
                            showToast(data.message || 'Failed to delete address.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting address:', error);
                        showToast('An error occurred. Please try again.', 'error');
                    });
                }
            });
        });
        
        // Make default address buttons
        const makeDefaultBtns = document.querySelectorAll('.make-default-btn');
        
        makeDefaultBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const addressId = this.dataset.addressId;
                
                // Send make default request
                fetch(`/make-default-address/${addressId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to reflect changes
                        window.location.reload();
                    } else {
                        showToast(data.message || 'Failed to set default address.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error setting default address:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
            });
        });
        
        // Check for edit_address param in URL
        const urlParams = new URLSearchParams(window.location.search);
        const editAddressId = urlParams.get('edit_address');
        
        if (editAddressId) {
            // Find and click the edit button for this address
            const editBtn = document.querySelector(`.edit-address-btn[data-address-id="${editAddressId}"]`);
            if (editBtn) {
                // First open the addresses tab
                openTab('addresses');
                
                // Then trigger the edit button click
                setTimeout(() => {
                    editBtn.click();
                }, 500);
            }
        }
    });
    
    // Helper function to get CSRF token
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
</script>
{% endblock %}
